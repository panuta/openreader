{% extends 'base_authenticated.html' %}
{% load helper_tags document_tags %}

{% block head_title %}{% if not shelf %}สร้างชั้นหนังสือใหม่{% else %}แก้ไขชั้นหนังสือ{% endif %}{% endblock %}
{% block topnav %}{% include 'snippets/organization_topnav.html' with active_menu='document' %}{% endblock %}

{% block html_head %}
{{block.super}}
<script>
function _append_permission(str, value) {
  if(!$('.shelf_permissions_input .permissions input[value="' + value + '"]').length) {
    $('.shelf_permissions_input .permissions').append('<li>' + str + ' <span>[ <a href="#">ลบออก</a> ]</span><input type="hidden" name="permission" value="' + value + '" /></li>');
  }
}

$(document).ready(function () {
  $('.choose_shelf_icon_button').on('click', function(e) {
    if($('#shelf_icons_modal').hasClass('uninitialized-modal')) {
      $('#shelf_icons_modal').removeClass('uninitialized-modal').modal({backdrop:'static'});

      $('#shelf_icons_modal .modal-body a').on('click', function(e) {
        $('.icon_input img').attr('src', $(this).find('img').attr('src'));
        $('.icon_input input').val($(this).attr('rel'));

        $('#shelf_icons_modal').modal('hide');
        return false;
      });

    } else {
      $('#shelf_icons_modal').modal('show');
    }
    return false;
  });

  $('.shelf_permissions_input li a').live('click', function(e) {
    $(this).closest('li').fadeOut(function() {
      $(this).remove();
    });
    return false;
  });

  $('.shelf_permissions_input .actions button').button();

  $('.shelf_permissions_input .actions button').on('click', function(e) {
    e.preventDefault();
    var panel_id = $('.permission_panel[rel="' + $(this).attr('id') + '"]').attr('id');
    if(!$(this).hasClass('active')) {
      $('.permission_panel').hide();
      $(this).prevAll('button').removeClass('active');
      $(this).nextAll('button').removeClass('active');

      $('#' + panel_id).slideDown('fast');
      $('#' + panel_id + ' .add_button').attr('disabled', true);

      // Clear
      $('#' + panel_id + ' input').attr('checked', false);
      $('#' + panel_id + ' select option:first').attr('selected', true);

      $('#shelf-permission-individual-panel .select_individual .as-selection-item').remove();
      $('#shelf-permission-individual-panel .select_individual .as-values').val('');

    } else {
      $('#' + panel_id).slideUp('fast');
    }
  });

  $('.permission_panel .cancel_button').on('click', function(e) {
    e.preventDefault();
    var button_id = $(this).closest('.permission_panel').slideUp('fast').attr('rel');
    $('#' + button_id).removeClass('active');
  });

  /* All People Permissions */
  $('#shelf-permission-all-panel .add_button').on('click', function(e) {
    e.preventDefault();
    var permission_value = $('#shelf-permission-all-panel input[type="radio"]:checked').val();
    if(permission_value == '2') {
      _append_permission('ทุกคนในบริษัทสามารถอัพโหลดไฟล์และแก้ไขไฟล์ได้', 'all-2');
    } else if(permission_value == '1') {
      _append_permission('ทุกคนในบริษัทสามารถดูไฟล์ได้อย่างเดียว (ยกเว้นผู้ดูแลระบบ)', 'all-1');
    }

    $('#shelf_permission_all_button').removeClass('active');
    $('#shelf-permission-all-panel').slideUp('fast');
  });

  $('#shelf-permission-all-panel input[type="radio"]').on('click', function(e) {
    $('#shelf-permission-all-panel .add_button').attr('disabled', false);
  });

  /* Group People Permissions */
  $('#shelf-permission-group-panel .add_button').on('click', function(e) {
    e.preventDefault();
    var group_id = $('#shelf-permission-group-panel select option:selected').val();
    var group_name = $('#shelf-permission-group-panel select option:selected').text();
    var permission_value = $('#shelf-permission-group-panel input[type="radio"]:checked').val();

    if(permission_value == '2') {
      _append_permission('กลุ่มผู้ใช้ <em>' + group_name + '</em> สามารถอัพโหลดไฟล์และแก้ไขไฟล์ได้', 'group-' + group_id + '-2');
    } else if(permission_value == '1') {
      _append_permission('กลุ่มผู้ใช้ <em>' + group_name + '</em> สามารถดูไฟล์ได้อย่างเดียว', 'group-' + group_id + '-1');
    }

    $('#shelf_permission_group_button').removeClass('active');
    $('#shelf-permission-group-panel').slideUp('fast');
  });

  $('#shelf-permission-group-panel input[type="radio"]').on('click', function(e) {
    if($('#shelf-permission-group-panel select').val() && $('#shelf-permission-group-panel input[name="group-shelf-permission"]:checked').length) {
      $('#shelf-permission-group-panel .add_button').attr('disabled', false);
    }
  });

  $('#shelf-permission-group-panel select').on('change', function(e) {
    if($('#shelf-permission-group-panel select').val() && $('#shelf-permission-group-panel input[name="group-shelf-permission"]:checked').length) {
      $('#shelf-permission-group-panel .add_button').attr('disabled', false);
    } else {
      $('#shelf-permission-group-panel .add_button').attr('disabled', true);
    }
  });

  /* Individual People Permissions */
  $('#shelf-permission-individual-panel .add_button').on('click', function(e) {
    e.preventDefault();

    var permission_text;
    var permission_value = $('#shelf-permission-individual-panel input[type="radio"]:checked').val();

    if(permission_value == '2') {
      permission_text = 'อัพโหลดไฟล์และแก้ไขไฟล์ได้';
    } else if(permission_value == '1') {
      permission_text = 'ดูไฟล์ได้อย่างเดียว';
    }

    $('#shelf-permission-individual-panel .as-selection-item').each(function() {
      _append_permission('ผู้ใช้ <em>' + $(this).data('user_name') + '</em> สามารถ' + permission_text, 'user-' + $(this).data('user_id') + '-' + permission_value);
    });

    $('#shelf_permission_individual_button').removeClass('active');
    $('#shelf-permission-individual-panel').slideUp('fast');
  });

  $('#shelf-permission-individual-panel input[type="radio"]').on('click', function(e) {
    if($('#shelf-permission-individual-panel .select_individual .as-values').val() && $('#shelf-permission-individual-panel input[name="individual-shelf-permission"]:checked').length) {
      $('#shelf-permission-individual-panel .add_button').attr('disabled', false);
    }
  });

  $('#shelf-permission-individual-panel .select_individual input').autoSuggest('{% url ajax_query_users organization.slug %}', {
    startText:"พิมพ์ชื่อผู้ใช้", emptyText:"ไม่พบผู้ใช้", selectedItemProp:'name', searchObjProps:'name',
    selectionAdded:function(elem, data) {
      elem.data('user_name', data['name']).data('user_id', data['value']);

      if($('#shelf-permission-individual-panel input[name="individual-shelf-permission"]:checked').length) {
        $('#shelf-permission-individual-panel .add_button').attr('disabled', false);
      }
    },
    selectionRemoved:function(elem) {
      if($('#shelf-permission-individual-panel .select_individual .as-values').val() == '' || $('#shelf-permission-individual-panel input[name="individual-shelf-permission"]:checked').length == 0) {
        $('#shelf-permission-individual-panel .add_button').attr('disabled', true);
      }
      elem.fadeTo("fast", 0, function(){ elem.remove(); });
    }
  });
})
</script>
{% endblock %}

{% block body_authenticated %}

<div class="fluid-container sidebar-left page-shelf-modify">
  {% include 'document/snippets/documents_sidebar.html' %}
  <div class="fluid-content"><div class="inner-content">
    {% if not shelf %}
    <h2>สร้างชั้นหนังสือใหม่</h2>
    {% else %}
    <ul class="breadcrumb">
      <li><a href="{% url view_documents_by_shelf organization.slug shelf.id %}">ชั้นหนังสือ {{shelf.name}}</a> <span class="divider">/</span></li>
      <li class="active">แก้ไขชั้นหนังสือ</li>
    </ul>
    <h2>แก้ไขชั้นหนังสือ</h2>
    {% endif %}

    <form method="POST" action=".">
      {% csrf_token %}
      {{form.non_field_errors}}

      <div class="item"><label for="id_name">ชื่อชั้นหนังสือ</label><div class="input">{{form.name}}{{form.name.errors}}</div></div>
      <div class="item"><label for="id_autosync">Auto-Sync</label><div class="input"><label class="checkbox">{{form.auto_sync}} ทุกไฟล์ในชั้นหนังสือนี้จะถูกดาวน์โหลดลงเครื่องผู้ใช้โดยอัตโนมัติ</label>{{form.auto_sync.errors}}</div></div>
      <div class="item"><label for="id_shelf_icon">ไอคอนชั้นหนังสือ</label><div class="input icon_input"><input type="hidden" name="shelf_icon" id="id_shelf_icon" value="{{form.shelf_icon.value}}" /><img src="{{STATIC_URL}}images/shelficons/24/{{form.shelf_icon.value}}.png" /><button class="small btn choose_shelf_icon_button">เลือกไอคอน</button></div></div>
      <div class="item">
        <label>การเข้าถึงชั้นหนังสือ</label>
        <div class="input shelf_permissions_input">
          <ul class="permissions">
            {% generate_shelf_permission_list shelf_permissions %}
          </ul>
          {{form.permission.errors}}
          <div class="actions">
            เพิ่มการเข้าถึงสำหรับ
            <button class="small btn" id="shelf_permission_all_button" data-toggle="button">ทุกคนใบบริษัท</button>
            <button class="small btn" id="shelf_permission_group_button" data-toggle="button">กลุ่มผู้ใช้</button>
            <button class="small btn" id="shelf_permission_individual_button" data-toggle="button">รายบุคคล</button>
          </div>

          <div class="permission_panel" id="shelf-permission-all-panel" rel="shelf_permission_all_button">
            <div class="head">ทุกคนในบริษัทสามารถ</div>
            <ul>
              <li><label><input type="radio" name="all-shelf-permission" value="2"/> อัพโหลดไฟล์และแก้ไขไฟล์ได้</label></li>
              <li><label><input type="radio" name="all-shelf-permission" value="1"/> ดูไฟล์ได้อย่างเดียว (ยกเว้นผู้ดูแลระบบ)</label></li>
            </ul>
            <div class="permission_actions"><button class="btn add_button"><i class="icon plus"></i> เพิ่มการเข้าถึง</button><button class="btn cancel_button">ยกเลิก</button></div>
          </div>

          <div class="permission_panel" id="shelf-permission-group-panel" rel="shelf_permission_group_button">
            <div class="head">กลุ่มผู้ใช้ <select>{% generate_group_select_options organization %}</select> สามารถ</div>
            <ul>
              <li><label><input type="radio" name="group-shelf-permission" value="2"/> อัพโหลดไฟล์และแก้ไขไฟล์ได้</label></li>
              <li><label><input type="radio" name="group-shelf-permission" value="1"/> ดูไฟล์ได้อย่างเดียว</label></li>
            </ul>
            <div class="permission_actions"><button class="btn add_button"><i class="icon plus"></i> เพิ่มการเข้าถึง</button><button class="btn cancel_button">ยกเลิก</button></div>
          </div>

          <div class="permission_panel" id="shelf-permission-individual-panel" rel="shelf_permission_individual_button">
            <div class="select_individual"><input type="text" /></div>
            <div class="head">ผู้ใช้สามารถ</div>
            <ul>
              <li><label><input type="radio" name="individual-shelf-permission" value="2"/> อัพโหลดไฟล์และแก้ไขไฟล์ได้</label></li>
              <li><label><input type="radio" name="individual-shelf-permission" value="1"/> ดูไฟล์ได้อย่างเดียว</label></li>
            </ul>
            <div class="permission_actions"><button class="btn add_button"><i class="icon plus"></i> เพิ่มการเข้าถึง</button><button class="btn cancel_button">ยกเลิก</button></div>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn primary">{% if not shelf %}สร้างชั้นหนังสือ{% else %}แก้ไขชั้นหนังสือ{% endif %}</button>
        <button type="reset" class="btn">ล้างข้อมูล</button>
      </div>
    </form>

    {% if shelf %}
    <div class="delete-panel">
      <a href="{% url delete_document_shelf organization.slug shelf.id %}" class="danger">ลบชั้นหนังสือ</a>
    </div>
    {% endif %}
  </div></div>
</div>

<div class="modal fade uninitialized-modal" id="shelf_icons_modal">
  <div class="modal-header"><a class="close" data-dismiss="modal">×</a><h3>เลือกไอคอน</h3></div>
  <div class="modal-body">
    <ul>
      {% generate_shelf_icons %}
    </ul>
  </div>
</div>

{% endblock %}