{% extends 'base_authenticated.html' %}
{% load helper_tags presentation_tags %}

{% block head_title %}{% if not shelf %}สร้างกลุ่มเอกสารใหม่{% else %}แก้ไขกลุ่มเอกสาร{% endif %}{% endblock %}
{% block topnav %}{% include 'snippets/organization_topnav.html' with active_menu='document' %}{% endblock %}

{% block extra_head %}
<script>
$(document).ready(function () {

    // Shelf Icon

    $('#shelf_icons_modal .modal-body a').on('click', function(e) {
        $('.shelf-icon-controls img').attr('src', $(this).find('img').attr('src'));
        $('.shelf-icon-controls input').val($(this).attr('rel'));
        $('#shelf_icons_modal').modal('hide');
        return false;
    });

    // Shelf User Permission

    $('.shelf-permission-controls a[href="#add-user-permission"]').on('click', function(e) {
        e.preventDefault();
        if(!$(this).hasClass('active')) {
            $('#add-user-permission').slideDown('fast');
            $('#add-user-permission .add_button').attr('disabled', true);

            $('#add-user-permission .input input').attr('checked', false);
            $('#add-user-permission .user_selection select option').attr('selected', false);
            $('#add-user-permission .user_selection select').trigger("liszt:updated");

        } else {
            $('#add-user-permission').slideUp('fast');
        }
    });

    $('#add-user-permission .add_button').on('click', function(e) {
        e.preventDefault();

        if(!$('.user_permissions table').length) {
            $('.user_permissions').append('<table class="table table-bordered"><tbody></tbody></table>');
        }

        var permission_value = $('#add-user-permission input[type="radio"]:checked').val();

        $('#add-user-permission .user_selection select option:selected').each(function() {
            var userObject;
            if($('.user_permissions table tr.user-permission-' + $(this).val()).length) {
                userObject = $('.user_permissions table tr.user-permission-' + $(this).val());
            } else {
                userObject = $('<tr class="user-permission-' + $(this).val() + '"><td class="remove"><button class="btn btn-mini">ยกเลิก</button></td><td class="group">' + $(this).text() + '</td><td class="permission"><label><input type="radio" name="user-permission-' + $(this).val() + '" value="2"/> อัพโหลดและแก้ไขไฟล์ได้</label><label><input type="radio" name="user-permission-' + $(this).val() + '" value="1"/> ดูไฟล์ได้อย่างเดียว</label><label><input type="radio" name="user-permission-' + $(this).val() + '" value="0"/> ไม่สามารถเข้าถึงได้</label></td></tr>');
                userObject.appendTo('.user_permissions table');
            }

            userObject.find('input').attr('checked', false);
            userObject.find('input[value="' + permission_value + '"]').attr('checked', true);
        });

        $('#add-user-permission').slideUp('fast');
        $('.shelf-permission-controls a[href="#add-user-permission"]').removeClass('active');
    });

    $('#add-user-permission .cancel_button').on('click', function(e) {
        $('#add-user-permission').slideUp('fast');
        $('.shelf-permission-controls a[href="#add-user-permission"]').removeClass('active');
        return false;
    });

    $('#add-user-permission .user_selection select').chosen().change(function(e) {
        if($(this).find('option:selected').length && $('#add-user-permission input[name="add-user-permission"]:checked').length) {
            $('#add-user-permission .add_button').attr('disabled', false);
        } else {
            $('#add-user-permission .add_button').attr('disabled', true);
        }
    });

    $('#add-user-permission input[type="radio"]').on('click', function(e) {
        if($('#add-user-permission .user_selection select option:selected').length && $('#add-user-permission input[name="add-user-permission"]:checked').length) {
            $('#add-user-permission .add_button').attr('disabled', false);
        }
    });

    $('.user_permissions table td.remove button').live('click', function() {
        $(this).closest('tr').remove();

        if(!$('.user_permissions table tr').length) {
            $('.user_permissions table').remove();
        }
    });
})
</script>
{% endblock %}

{% block body_authenticated %}
<div class="container-fluid modify_shelf_page"><div class="row-fluid">
    <div class="content"><div class="inner-content">

        {% if not shelf %}
            <ul class="breadcrumb">
                <li><a href="{% url view_documents organization.slug %}">กลุ่มเอกสารทั้งหมด</a> <span class="divider">/</span></li>
                <li class="active">สร้างกลุ่มเอกสารใหม่</li>
            </ul>
            <h2>สร้างกลุ่มเอกสารใหม่</h2>
        {% else %}
            <ul class="breadcrumb">
                <li><a href="{% url view_documents organization.slug %}">กลุ่มเอกสารทั้งหมด</a> <span class="divider">/</span></li>
                <li><a href="{% url view_documents_by_shelf organization.slug shelf.id %}">กลุ่มเอกสาร {{shelf.name}}</a> <span class="divider">/</span></li>
                <li class="active">แก้ไขกลุ่มเอกสาร</li>
            </ul>
            <h2>แก้ไขกลุ่มเอกสาร</h2>
        {% endif %}

        <form method="POST" action=".">
            {% csrf_token %}
            {{form.non_field_errors}}

            <div class="control-group">
                <label class="control-label" for="id_name">ชื่อกลุ่มเอกสาร</label>
                <div class="controls">{{form.name}}{{form.name.errors}}</div>
            </div>

            <div class="control-group">
                <label class="control-label" for="id_email">Auto-Sync</label>
                <div class="controls row-controls"><ul><li><label>{{form.auto_sync}} ทุกไฟล์ในกลุ่มเอกสารนี้จะถูกดาวน์โหลดลงเครื่องผู้ใช้โดยอัตโนมัติ</label></li></ul>{{form.auto_sync.errors}}</div>
            </div>

            <div class="control-group">
                <label class="control-label" for="id_shelf_icon">ไอคอนกลุ่มเอกสาร</label>
                <div class="controls shelf-icon-controls">
                    <input type="hidden" name="shelf_icon" id="id_shelf_icon" value="{{form.shelf_icon.value}}" /><img src="{{STATIC_URL}}images/shelficons/24/{{form.shelf_icon.value}}.png" /><button class="btn btn-small" data-toggle="modal" data-target="#shelf_icons_modal">เปลี่ยนไอคอน</button>
                </div>
            </div>

            <div class="control-group">
                <label class="control-label" for="id_email">การเข้าถึงกลุ่มเอกสาร</label>
                <div class="controls shelf-permission-controls">
                    <table class="table table-bordered">
                        <tbody>
                            <tr>
                                <td class="group">ทุกคนในบริษัท</td>
                                <td class="permission">
                                    {% if shelf %}
                                        {% shelf_organization_permission_radio shelf %}
                                    {% else %}
                                        <label><input type="radio" name="all-permission" value="2"/> อัพโหลดและแก้ไขไฟล์ได้</label>
                                        <label><input type="radio" name="all-permission" value="1" checked="checked"/> ดูไฟล์ได้อย่างเดียว</label>
                                    {% endif %}
                                </td>
                            </tr>
                            {% for group in organization.organizationgroup_set.all %}
                            <tr>
                                <td class="group">กลุ่มผู้ใช้ <em>{{ group.name }}</em></td>
                                <td class="permission">
                                    {% if shelf %}
                                        {% shelf_group_permission_radio group shelf %}
                                    {% else %}
                                        <label><input type="radio" name="group-permission-{{ group.id }}" value="2"/> อัพโหลดและแก้ไขไฟล์ได้</label>
                                        <label><input type="radio" name="group-permission-{{ group.id }}" value="1" checked="checked"/> ดูไฟล์ได้อย่างเดียว</label>
                                        <label><input type="radio" name="group-permission-{{ group.id }}" value="0"/> ไม่สามารถเข้าถึงได้</label>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div class="user_permissions">
                        <h4>การเข้าถึงเป็นรายบุคคล</h4>
                        <a href="#add-user-permission" class="btn btn-small" data-toggle="button">เพิ่มการเข้าถึงเป็นรายบุคคล</a>

                        <div id="add-user-permission" class="hide permission_panel">
                            <div class="user_selection">
                                <select multiple="multiple" data-placeholder="เลือกผู้ใช้">{% generate_user_select_options organization %}</select>
                            </div>
                            <div class="head">ผู้ใช้สามารถ</div>
                            <div class="input">
                                <label><input type="radio" name="add-user-permission" value="2"/> อัพโหลดและแก้ไขไฟล์ได้</label>
                                <label><input type="radio" name="add-user-permission" value="1"/> ดูไฟล์ได้อย่างเดียว</label>
                                <label><input type="radio" name="add-user-permission" value="0"/> ไม่สามารถเข้าถึงได้</label>
                            </div>
                            <div class="permission_actions">
                                <button class="btn add_button"><i class="icon-plus"></i> เพิ่มการเข้าถึง</button>
                                <button class="btn cancel_button">ยกเลิก</button>
                            </div>
                        </div>

                        {% if shelf %}
                            <table class="table table-bordered">
                                <tbody>
                                    {% for user_permission in shelf.usershelfpermission_set.all %}
                                    <tr class="user-permission-{{ user_permission.user.id }}">
                                        <td class="remove"><button class="btn btn-mini">ยกเลิก</button></td>
                                        <td class="group">{{ user_permission.user.get_profile.get_fullname }}</td>
                                        <td class="permission">{% shelf_user_permission_radio user_permission %}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary"><i class="icon-ok icon-white"></i> {% if not shelf %}สร้างกลุ่มเอกสาร{% else %}แก้ไขกลุ่มเอกสาร{% endif %}</button>
                <button type="reset" class="btn">ล้างข้อมูล</button>
            </div>
        </form>

        {% if shelf %}
        <div class="delete-panel">
            <a href="{% url delete_document_shelf organization.slug shelf.id %}" class="danger">ลบกลุ่มเอกสาร</a>
        </div>
        {% endif %}
    </div></div>
</div></div>

<div class="modal hide" id="shelf_icons_modal">
  <div class="modal-header"><a class="close" data-dismiss="modal">×</a><h3>เลือกไอคอน</h3></div>
  <div class="modal-body">
    <ul>
      {% generate_shelf_icons %}
    </ul>
  </div>
</div>
{% endblock %}