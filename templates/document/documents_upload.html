{% extends 'base_authenticated.html' %}
{% load helper_tags document_tags %}

{% block head_title %}อัพโหลดไฟล์{% endblock %}
{% block topnav %}{% include 'snippets/organization_topnav.html' with active_menu='document' %}{% endblock %}

{% block html_head %}
{{block.super}}

<script type="text/javascript" src="{{STATIC_URL}}libs/plupload/plupload.full.js"></script>
<script>
$(document).ready(function () {
  $('#upload_errors li a').live('click', function(e) {
    $(this).closest('li').remove();
  });

  var uploader = new plupload.Uploader({
    runtimes : 'html5,flash',
    browse_button : 'select_files_button',
    container : 'upload_dropzone',
    drop_element: 'upload_dropzone',
    url : '{% url upload_documents organization.slug %}',
    flash_swf_url : '{{STATIC_URL}}libs/plupload/plupload.flash.swf',
    multipart: true,
    headers: {'X-Requested-With':'XMLHttpRequest', 'X-CSRFToken':'{{csrf_token}}'}
  });

  uploader.init();

  uploader.bind('FilesAdded', function(up, files) {
    $.each(files, function(i, file) {
      var new_job = $('<li class="uploading" id="' + file.id + '"><div class="filename">' + file.name + '</div><div class="upload_progressbar"></div><div class="upload_actions"></div></li>');
      new_job.find('.upload_progressbar').progressBar({width:262, height:20, boxImage:'/static/libs/progressbar/images/progressbar.png', barImage:{0:'/static/libs/progressbar/images/progressbg.png', 30:'/static/libs/progressbar/images/progressbg.png', 70:'/static/libs/progressbar/images/progressbg.png'}});
      new_job.prependTo('#upload_jobs');
    });

    up.refresh(); // Reposition Flash/Silverlight
    up.start();
  });

  uploader.bind('UploadProgress', function(up, file) {
    $('#' + file.id + ' .upload_progressbar').progressBar(file.percent);
  });

  uploader.bind('Error', function(up, err) {
    if(err.file) {
      $('#' + err.file.id + ' .upload_actions').append('<span class="error">' + err.message + '</span>')
    } else {
      $('#upload_errors').prepend('<li>' + err.message + '<span>[ <a href="#">ปิดข้อความ</a> ]</span></li>')
    }

    up.refresh(); // Reposition Flash/Silverlight
  });

  uploader.bind('FileUploaded', function(up, file, response) {
    var file_id = file.id;
    var responseObject = eval('(' + response.response + ')'); // Django returns response as JSON

    if(responseObject.status == 'success') {
      $('#' + file_id).removeClass('uploading').addClass('uploaded');
      $('#' + file_id).html('<div class="filename">' + file.name + '</div><div class="finished"><strong>อัพโหลดเรียบร้อย</strong> กรอกรายละเอียดไฟล์ด้านล่าง</div><div class="input"><form><label>ชื่อไฟล์</label><input type="text" name="title" value="' + responseObject.title + '" /> <span class="shelf_input"><label>ชั้นหนังสือ</label><select name="shelf"><option></option>{% generate_shelf_options organization %}</select></span> <input type="hidden" name="uid" value="' + responseObject.uid + '" /><button class="save btn">บันทึก</button></form></div>');

      if(!$('#' + file_id + ' select').text()) {
        $('#' + file_id + ' .shelf_input').remove();
      }

      $('#' + file_id + ' button.save').on('click', function(e) {
        var uid = $('#' + file_id + ' input[name="uid"]').val();
        var title = $('#' + file_id + ' input[name="title"]').val();
        var shelf_id = $('#' + file_id + ' select[name="shelf"] option:selected').val();

        if(!uid || !title) {
          return false;
        }

        $.post('{% url finishing_upload_documents organization.slug %}', {uid:uid, title:title, shelf_id:shelf_id}, function(result) {
          $('#' + file_id).removeClass('uploaded').addClass('completed').html('<div class="filename"><a href="' + result.view_url + '">' + result.title + '</a></div><div class="finished">บันทึกข้อมูลเรียบร้อย</div><div class="upload_actions"><button class="btn publish_button"><span>เผยแพร่</span></button><a href="' + result.edit_url + '" class="link">แก้ไขรายละเอียดไฟล์</a></div>');

          // TODO: Change shelf number on the left

          $('#' + file_id + ' button.publish_button').on('click', function(e) {
            open_publish_modal(result.uid, function(result, uid) {
              if(result.error == 'processing') {
                $('#' + file_id + ' .finished').text('ไฟล์นี้กำลังประมวลผลอยู่ ระบบจะเผยแพร่ทันทีที่ประมวลผลเสร็จ');
              } else {
                $('#' + file_id + ' .finished').text('เผยแพร่เรียบร้อย');
              }
              
              $('#' + file_id + ' button.publish_button').remove();
              return true;
            });

            return false;
          });
        }, 'json').error(function(e) { // SAVE DETAILS ERRORS
          $('#' + file_id + ' .input .error').remove();
          if(e.responseText == 'document-not-found') $('#' + file_id + ' .input').append('<span class="error">ไม่พบไฟล์เอกสารที่ต้องการบันทึกข้อมูล</span>');
          if(e.responseText == 'shelf-not-found') $('#' + file_id + ' .input').append('<span class="error">ไม่พบชั้นหนังสือที่ต้องการบันทึกข้อมูล</span>');
          if(e.responseText == 'access-denied') $('#' + file_id + ' .input').append('<span class="error">ผู้ใช้ไม่มีสิทธิ์เข้าถึงข้อมูลที่ต้องการบันทึก</span>');
          if(e.responseText == 'missing-parameters') $('#' + file_id + ' .input').append('<span class="error">ข้อมูลไม่ครบถ้วย</span>');
        });

        return false;
      });

      
    } else if(responseObject.status == 'error') { // UPLOAD ERRORS
      if(responseObject.error == 'file-missing') $('#' + file_id + ' .upload_actions').append('<span class="error">ไม่สามารถอ่านไฟล์ที่ต้องการอัพโหลดได้</span>')
    }
  });
});
</script>

{% endblock %}

{% block body_authenticated %}
<div class="container-fluid container-body documents_upload_page">
  <div class="sidebar">
    {% can user 'edit' organization %}<div class="buttons"><a href="{% url upload_documents organization.slug %}" class="btn primary upload_publication_button"><span>อัพโหลดไฟล์</span></a></div>{% endcan %}
    
    <div class="head"><a href="{% url view_documents organization.slug %}">ชั้นหนังสือ</a></div>
    <ul>
      <li class="shelf-all"><a href="{% url view_documents organization.slug %}">ไฟล์ทั้งหมด <span>({% print_all_publication_count user organization %} ไฟล์)</span></a></li>
      {% generate_shelf_list user organization '' %}
      {% if no_shelf_count %}<li class="shelf-none"><a href="{% url view_documents_with_no_shelf organization.slug %}">ไฟล์ที่ไม่อยู่ในชั้น <span>({{no_shelf_count}} ไฟล์)</span></a></li>{% endif %}
      {% can user 'manage' organization %}<li class="add"><a href="{% url create_document_shelf organization.slug %}">สร้างชั้นหนังสือใหม่</a></li>{% endcan %}
    </ul>
  </div>

  <div class="content"><div class="content-inner">
    <h2>อัพโหลดไฟล์</h2>

    <div class="upload_dropzone" id="upload_dropzone">
      <a href="#" class="btn select_files_button" id="select_files_button"><span>เลือกไฟล์</span></a>
      <div class="dragdrop">หรือลากไฟล์มาวางที่กรอบนี้</div>
    </div>

    <ul id="upload_errors"></ul>
    <ul id="upload_jobs"></ul>

  </div></div>
</div>

{% endblock %}